<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSpider文档</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/js-spider/css/default.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/js-spider/css/github-gist.min.css">
    <link rel="stylesheet" href="./css/index.css">

</head>

<body>
    <header>
        <div id="title">KonghaYao</div>
        <ul id="link">
            <li>
                <a href="" id='Gitee'>
                    <img src="https://gitee.com/assets/favicon_message.ico" />
                </a>
            </li>
            <li>
                <a href="" id='NPM'>
                    <img
                        src="https://cdn.jsdelivr.net/www.jsdelivr.com/1460460532416742d94c2a4bbc2893bdd1081bdd/img/landing/npm.png" />
                </a>
            </li>
            <li>
                <a href="" id='Github'>
                    <img src="https://github.githubassets.com/favicons/favicon.png" />
                </a>
            </li>
        </ul>
    </header>
    <div id='md'></div>
</body>


<script src="https://cdn.jsdelivr.net/npm/showdown/dist/showdown.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.0.0/highlight.min.js"></script>

<script type='module'>
    import JSpider from "./JSpider-pro.js"
    window.JSpider = JSpider
</script>

<script>
    let root = 'https://cdn.jsdelivr.net/gh/konghayao/jspider/doc/'


    const Title = document.getElementById('title')
    const LinkList = document.getElementById('link')
    Object.defineProperty(LinkList, "html", {
        set(value) {
            console.log(value)
            Object.entries(value).forEach(([key, value]) => {
                LinkList.querySelector('#' + key).href = value || ''
            })
        }
    })

    hljs.initHighlightingOnLoad();
    const marked = new showdown.Converter({
        tables: true,
        parseImgDimensions: true,
        strikethrough: true,
        tasklists: true,
        literalMidWordUnderscores: true,
        metadata: true,
        noHeaderId: true,
        emoji: true,
    });
    const md = document.getElementById('md')


    window.onload = async function () {
        let file = location.hash.replace(/^#/, '.') || './JSpider.md'
        console.log(file)
        await toWhere(file)

    }

    function toWhere(path) {
        let num = 0

        let hash = location.hash.replace(/^#/, '')
        if (path.replace(/[\/|\.|#]/g, '') == hash.replace(/[\/|\.|#]/g, '')) {
            init(path)
            return;
        }
        if (/^\.\//.test(path)) {
            while (/\/[^\/]*?\.[^\/]*?$/.test(hash)) {
                hash = hash.replace(/\/[^\/]*?\.[^\/]*?$/, '')
            }
        }
        path = path.replace(/\.\.\//g, () => {
            num += 1
            return ''
        })
        for (; num > 0; num--) {
            hash = hash.replace(/(\/[^\/]+?$)|(\/[^\/]+?\/$)/, (p0) => {
                /\./.test(p0) && num++
                return ''
            })
        }
        hash += '/'
        if (/(^\.\/)|(^\/)/.test(path)) {
            console.log(path)
            hash = path.replace(/(^\.\/)|(^\/)/, hash)
        } else {
            hash += path
        }
        console.log(hash)
        hash = hash.replace(/\/\//g, '/')
        location.hash = hash
        init(hash)
    }

    async function init(url) {
        return await fetch((root + url).replace(/\/\//g, '/')).then(res => res.text()).then(res => {
            if (res) redirect(res);
        })
    }
    function redirect(res) {
        md.innerHTML = marked.makeHtml(res)
        document.querySelectorAll('#md > pre').forEach(i => {
            hljs.highlightBlock(i)
        })

        document.querySelectorAll('#md  a').forEach(i => {
            i.onclick = (e) => {
                e.preventDefault();
                toWhere(e.target.outerHTML.match(/(?<=href\=")[\s\S]+?(?=")/)[0]);
            }
        })
        scrollTo(0, 0)
        let { title, NPM, Github, Gitee } = marked.getMetadata()
        Title.innerHTML = title || 'KonghaYao'
        let obj = { NPM, Github, Gitee }
        LinkList.html = obj
    }

</script>

</html>