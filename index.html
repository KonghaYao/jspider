<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSpider文档</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/js-spider/css/default.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/js-spider/css/github-gist.min.css">
    <link rel="stylesheet" href="./css/index.css">

</head>

<body>
    <header>
        <div id="title">KonghaYao</div>
        <ul id="link">
            <li>
                <a href="" id='Gitee'>
                    <img src="https://gitee.com/assets/favicon_message.ico" />
                </a>
            </li>
            <li>
                <a href="" id='NPM'>
                    <img
                        src="https://cdn.jsdelivr.net/www.jsdelivr.com/1460460532416742d94c2a4bbc2893bdd1081bdd/img/landing/npm.png" />
                </a>
            </li>
            <li>
                <a href="" id='Github'>
                    <img src="https://github.githubassets.com/favicons/favicon.png" />
                </a>
            </li>
        </ul>
    </header>
    <div id='md'></div>
</body>


<script src="https://cdn.jsdelivr.net/npm/showdown/dist/showdown.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.0.0/highlight.min.js"></script>
<script type='module'>
    import JSpider from "./JSpider-pro.js"
    window.JSpider = JSpider


</script>
<script>

    const Title = document.getElementById('title')
    const LinkList = document.getElementById('link')
    Object.defineProperty(LinkList, "html", {
        set(value) {
            console.log(value)
            Object.entries(value).forEach(([key, value]) => {
                LinkList.querySelector('#' + key).href = value || ''
            })
        }
    })

    hljs.initHighlightingOnLoad();
    const marked = new showdown.Converter({
        tables: true,
        parseImgDimensions: true,
        strikethrough: true,
        tasklists: true,
        literalMidWordUnderscores: true,
        metadata: true,
        noHeaderId: true,
        emoji: true,
    });
    const md = document.getElementById('md')
    const root = './doc'
    URl = 'https://cdn.jsdelivr.net/npm/js-spider'

    window.onload = async function () {
        await init('/JSpider.md')
        let { title, NPM, Github, Gitee } = marked.getMetadata()
        Title.innerHTML = title || 'KonghaYao'
        let obj = { NPM, Github, Gitee }
        LinkList.html = obj

    }

    function toWhere(path) {
        let url = new URL(path)
        init(url.pathname.replace('/jspider', ''))
    }
    async function init(path) {
        path = root + path
        console.log(path)
        return await fetch(URl + path).then(res => {
            if (res.ok) {
                return res.text()
            }
        }).then(res => {
            if (res) redirect(res);
        })
    }
    function redirect(res) {
        md.innerHTML = marked.makeHtml(res)
        document.querySelectorAll('#md > pre').forEach(i => {
            hljs.highlightBlock(i)
        })

        document.querySelectorAll('#md > a').forEach(i => {
            i.onclick = (e) => {
                e.preventDefault();
                toWhere(e.target.href)
            }
        })
        scrollTo(0, 0)

    }

</script>

</html>