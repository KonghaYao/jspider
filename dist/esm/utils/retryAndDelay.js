/**
 * MIT License
 * 
 * Copyright (c) 2020 动中之动
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */

import{O as t,p as e}from"../subscribeTo-a0871bd2.js";import{_ as r,b as i,r as s,S as n,d as o}from"../Subscriber-4bc9607d.js";import{i as u,S as c,a as h}from"../innerSubscribe-6069f3a4.js";import{d as l}from"../delayWhen-2c1232cb.js";import{i as a}from"../isScheduler-8c992f4d.js";var d=function(){function t(){return Error.call(this),this.message="object unsubscribed",this.name="ObjectUnsubscribedError",this}return t.prototype=Object.create(Error.prototype),t}(),p=function(t){function e(e,r){var i=t.call(this)||this;return i.subject=e,i.subscriber=r,i.closed=!1,i}return r(e,t),e.prototype.unsubscribe=function(){if(!this.closed){this.closed=!0;var t=this.subject,e=t.observers;if(this.subject=null,e&&0!==e.length&&!t.isStopped&&!t.closed){var r=e.indexOf(this.subscriber);-1!==r&&e.splice(r,1)}}},e}(i),f=function(t){function e(e){var r=t.call(this,e)||this;return r.destination=e,r}return r(e,t),e}(n),b=function(e){function n(){var t=e.call(this)||this;return t.observers=[],t.closed=!1,t.isStopped=!1,t.hasError=!1,t.thrownError=null,t}return r(n,e),n.prototype[s]=function(){return new f(this)},n.prototype.lift=function(t){var e=new v(this,this);return e.operator=t,e},n.prototype.next=function(t){if(this.closed)throw new d;if(!this.isStopped)for(var e=this.observers,r=e.length,i=e.slice(),s=0;s<r;s++)i[s].next(t)},n.prototype.error=function(t){if(this.closed)throw new d;this.hasError=!0,this.thrownError=t,this.isStopped=!0;for(var e=this.observers,r=e.length,i=e.slice(),s=0;s<r;s++)i[s].error(t);this.observers.length=0},n.prototype.complete=function(){if(this.closed)throw new d;this.isStopped=!0;for(var t=this.observers,e=t.length,r=t.slice(),i=0;i<e;i++)r[i].complete();this.observers.length=0},n.prototype.unsubscribe=function(){this.isStopped=!0,this.closed=!0,this.observers=null},n.prototype._trySubscribe=function(t){if(this.closed)throw new d;return e.prototype._trySubscribe.call(this,t)},n.prototype._subscribe=function(t){if(this.closed)throw new d;return this.hasError?(t.error(this.thrownError),i.EMPTY):this.isStopped?(t.complete(),i.EMPTY):(this.observers.push(t),new p(this,t))},n.prototype.asObservable=function(){var e=new t;return e.source=this,e},n.create=function(t,e){return new v(t,e)},n}(t),v=function(t){function e(e,r){var i=t.call(this)||this;return i.destination=e,i.source=r,i}return r(e,t),e.prototype.next=function(t){var e=this.destination;e&&e.next&&e.next(t)},e.prototype.error=function(t){var e=this.destination;e&&e.error&&this.destination.error(t)},e.prototype.complete=function(){var t=this.destination;t&&t.complete&&this.destination.complete()},e.prototype._subscribe=function(t){return this.source?this.source.subscribe(t):i.EMPTY},e}(b),y=function(t){function e(e,r){var i=t.call(this,e,r)||this;return i.scheduler=e,i.work=r,i.pending=!1,i}return r(e,t),e.prototype.schedule=function(t,e){if(void 0===e&&(e=0),this.closed)return this;this.state=t;var r=this.id,i=this.scheduler;return null!=r&&(this.id=this.recycleAsyncId(i,r,e)),this.pending=!0,this.delay=e,this.id=this.id||this.requestAsyncId(i,this.id,e),this},e.prototype.requestAsyncId=function(t,e,r){return void 0===r&&(r=0),setInterval(t.flush.bind(t,this),r)},e.prototype.recycleAsyncId=function(t,e,r){if(void 0===r&&(r=0),null!==r&&this.delay===r&&!1===this.pending)return e;clearInterval(e)},e.prototype.execute=function(t,e){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var r=this._execute(t,e);if(r)return r;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},e.prototype._execute=function(t,e){var r=!1,i=void 0;try{this.work(t)}catch(t){r=!0,i=!!t&&t||new Error(t)}if(r)return this.unsubscribe(),i},e.prototype._unsubscribe=function(){var t=this.id,e=this.scheduler,r=e.actions,i=r.indexOf(this);this.work=null,this.state=null,this.pending=!1,this.scheduler=null,-1!==i&&r.splice(i,1),null!=t&&(this.id=this.recycleAsyncId(e,t,null)),this.delay=null},e}(function(t){function e(e,r){return t.call(this)||this}return r(e,t),e.prototype.schedule=function(t,e){return this},e}(i)),w=function(){function t(e,r){void 0===r&&(r=t.now),this.SchedulerAction=e,this.now=r}return t.prototype.schedule=function(t,e,r){return void 0===e&&(e=0),new this.SchedulerAction(this,t).schedule(r,e)},t.now=function(){return Date.now()},t}(),m=new(function(t){function e(r,i){void 0===i&&(i=w.now);var s=t.call(this,r,(function(){return e.delegate&&e.delegate!==s?e.delegate.now():i()}))||this;return s.actions=[],s.active=!1,s.scheduled=void 0,s}return r(e,t),e.prototype.schedule=function(r,i,s){return void 0===i&&(i=0),e.delegate&&e.delegate!==this?e.delegate.schedule(r,i,s):t.prototype.schedule.call(this,r,i,s)},e.prototype.flush=function(t){var e=this.actions;if(this.active)e.push(t);else{var r;this.active=!0;do{if(r=t.execute(t.state,t.delay))break}while(t=e.shift());if(this.active=!1,r){for(;t=e.shift();)t.unsubscribe();throw r}}},e}(w))(y);function S(t){return!o(t)&&t-parseFloat(t)+1>=0}function x(e,r,i){void 0===e&&(e=0);var s=-1;return S(r)?s=Number(r)<1?1:Number(r):a(r)&&(i=r),a(i)||(i=m),new t((function(t){var r=S(e)?e:+e-i.now();return i.schedule(g,r,{index:0,period:s,subscriber:t})}))}function g(t){var e=t.index,r=t.period,i=t.subscriber;if(i.next(e),!i.closed){if(-1===r)return i.complete();t.index=e+1,this.schedule(t,r)}}var _=function(){function t(t,e,r){void 0===r&&(r=!1),this.accumulator=t,this.seed=e,this.hasSeed=r}return t.prototype.call=function(t,e){return e.subscribe(new E(t,this.accumulator,this.seed,this.hasSeed))},t}(),E=function(t){function e(e,r,i,s){var n=t.call(this,e)||this;return n.accumulator=r,n._seed=i,n.hasSeed=s,n.index=0,n}return r(e,t),Object.defineProperty(e.prototype,"seed",{get:function(){return this._seed},set:function(t){this.hasSeed=!0,this._seed=t},enumerable:!0,configurable:!0}),e.prototype._next=function(t){if(this.hasSeed)return this._tryNext(t);this.seed=t,this.destination.next(t)},e.prototype._tryNext=function(t){var e,r=this.index++;try{e=this.accumulator(this.seed,t,r)}catch(t){this.destination.error(t)}this.seed=e,this.destination.next(e)},e}(n);var j=function(){function t(t,e){this.notifier=t,this.source=e}return t.prototype.call=function(t,e){return e.subscribe(new A(t,this.notifier,this.source))},t}(),A=function(t){function e(e,r,i){var s=t.call(this,e)||this;return s.notifier=r,s.source=i,s}return r(e,t),e.prototype.error=function(e){if(!this.isStopped){var r=this.errors,i=this.retries,s=this.retriesSubscription;if(i)this.errors=void 0,this.retriesSubscription=void 0;else{r=new b;try{i=(0,this.notifier)(r)}catch(e){return t.prototype.error.call(this,e)}s=u(i,new c(this))}this._unsubscribeAndRecycle(),this.errors=r,this.retries=i,this.retriesSubscription=s,r.next(e)}},e.prototype._unsubscribe=function(){var t=this.errors,e=this.retriesSubscription;t&&(t.unsubscribe(),this.errors=void 0),e&&(e.unsubscribe(),this.retriesSubscription=void 0),this.retries=void 0},e.prototype.notifyNext=function(){var t=this._unsubscribe;this._unsubscribe=null,this._unsubscribeAndRecycle(),this._unsubscribe=t,this.source.subscribe(this)},e}(h);const I=(t,r)=>{return e((i=e=>e.pipe(function(t,e){var r=!1;return arguments.length>=2&&(r=!0),function(i){return i.lift(new _(t,e,r))}}(((e,r)=>{if(console.log("尝试次数",e),e>=t)throw new Error("超出尝试次数",r);return e+1}),0),l(((...t)=>{switch(typeof r){case"string":case"number":return x(parseInt(r));case"function":return x(r(...t));default:throw new Error("您输入的 delay 错误")}}))),function(t){return t.lift(new j(i,t))}));var i};export{I as retryAndDelay};
